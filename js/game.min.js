function Level(){this.cameraX=0;this.cameraY=0;this.load=function(e){var t=null;var n=new XMLHttpRequest;n.open("GET","levels/"+e+".json",false);n.onreadystatechange=function(){if(n.readyState==4){t=JSON.parse(n.responseText)}};n.send();return t};this.draw=function(e){levelDataText.value+="Attempting Loop of levelData \n";for(var t=1;t<=15;t++){if(e[t].length!==0){levelDataText.value+="\n\nRow "+t+"\n"}for(var n=0;n<e[t].length;n++){var r=n*42;var i=t*42;if(e[t].length!==0){levelDataText.value+=n+": "+e[t][n]+" => "+this.numToTile(e[t][n])+" || Will be drawn at:"+r+", "+i+" || \n";var s=new Tile(this.numToTile(e[t][n]),r,i);s.draw();scene.push(s)}}}};this.clear=function(){scene=[]};this.numToTile=function(e){var t=["air","grass","dirt","stone","water","lava","brick"];return t[e]};this.moveCamera=function(e,t){for(var n=1;n<scene.length;n++){scene[n].x+=e;scene[n].y+=t}}}function collisionTest(e,t){return!(e.y+e.h<t.y||e.y>t.y+t.h||e.x+e.w<t.x||e.x>t.x+t.w)}function Cloud(e,t,n,r){this.w=n||Math.floor(Math.random()*400)+50;this.h=r||Math.floor(Math.random()*200)+50;this.x=e||0-this.w;this.y=t||Math.floor(Math.random()*200)-100;var i=Math.random()+.1;this.draw=function(){context.beginPath();context.rect(this.x,this.y,this.w,this.h);context.fillStyle="rgba(225,225,225,"+i+")";context.fill()}}function Tile(e,t,n,r,i){this.x=t||0;this.y=n||200;this.w=r||42;this.h=i||42;this.type=e;this.collision=true;this.GRAVITATIONAL_ACCELERATION=0;this.draw=function(){if(e=="grass"){context.beginPath();context.rect(this.x,this.y,this.w,this.h);context.fillStyle="#94d088";context.fill();context.beginPath();context.rect(this.x,this.y+12,this.w,this.h-12);context.fillStyle="#ab846c";context.fill()}if(e=="dirt"){context.beginPath();context.rect(this.x,this.y,this.w,this.h);context.fillStyle="#ab846c";context.fill()}if(e=="stone"){context.beginPath();context.rect(this.x,this.y,this.w,this.h);context.fillStyle="#6f6f6f";context.fill()}if(e=="water"){context.beginPath();context.rect(this.x,this.y,this.w,this.h);context.fillStyle="rgba(0, 156, 255, 0.5)";context.fill();this.collision=false}if(e=="lava"){context.beginPath();context.rect(this.x,this.y,this.w,this.h);context.fillStyle="#d27922";context.fill();this.collision=false}if(e=="air"){this.collision=false}};this.gravity=function(e){return false}}function Gravity(e){this.objectsArray=e;this.enabled=true;this.enable=function(t){if(this.enabled==true){for(var n=0;n<e.length;n++){e[n].gravity(t)}}else{for(var n=0;n<e.length;n++){e[n].gravity(0)}}}}function Player(e,t,n,r){this.x=e||10;this.y=t||450;this.w=n||40;this.h=r||90;this.lastMovement="down";this.jumping=false;this.collide=false;this.GRAVITATIONAL_ACCELERATION=2;this.health=250;this.bullets=[];this.move=function(e,t){this.x+=e;this.y+=t};this.gravity=function(e){this.GRAVITATIONAL_ACCELERATION=e;this.move(0,this.GRAVITATIONAL_ACCELERATION)};this.oppositeMove=function(e){switch(e){case"left":this.move(15,0);break;case"up":this.move(0,-5);break;case"right":this.move(-15,0);break;case"down":this.move(0,-1);break;default:return false}return true};this.futureCollisionTest=function(e,t,n){var r=!(e.y+n[1]+e.h<t.y||e.y+n[1]>t.y+t.h||e.x+n[0]+e.w<t.x||e.x+n[0]>t.x+t.w);return r};this.resize=function(e,t){this.w=e;this.h=t};this.jump=function(){if(this.jumping==false){this.y+=-100;this.jumping=true}if(this.collide=true){this.jumping=false}this.collide=false};this.draw=function(){var e=new Image;e.src="img/characters/soldier_single.png";context.drawImage(e,this.x,this.y+19)};this.attack=function(){var e=new Bullet(this.x+40,this.y+60);e.draw();this.bullets.push(e);scene.push(e)}}function Bullet(e,t){this.x=e;this.y=t;this.w=4;this.h=4;this.draw=function(){context.beginPath();context.arc(this.x,this.y,4,0,2*Math.PI,false);context.fillStyle="#fff";context.fill()}}function UserInterface(){this.drawHealth=function(e){context.beginPath();context.rect(50,20,e,15);if(e<100){context.fillStyle="#ae3636"}else{context.fillStyle="#35c131"}context.fill();context.fillStyle="#000";context.fillText("HP: "+e,320,30)};this.gameOver=function(e,t){context.clearRect(0,0,canvas.width,canvas.height);context.beginPath();context.rect(0,0,1280,672);if(t){context.fillStyle="#51e482";context.fill();context.fillStyle="#000";context.font="30px Arial";context.fillText("Congratulations!!",540,200);context.font="20px Arial";context.fillText("Score = "+Math.round((score+e+player1.health)*100),540,300)}else{context.fillStyle="#ae3636";context.fill();context.fillStyle="#000";context.font="30px Arial";context.fillText("Game Over!!",540,200);context.font="20px Arial";context.fillText("Score = "+Math.round((score+e+player1.health)*100),540,300)}}}function Enemy(e,t,n,r,i){this.type=e;this.x=t||10;this.y=n||450;this.w=r||40;this.h=i||90;this.movementDirection=1;this.GRAVITATIONAL_ACCELERATION=2;this.lastMovement="down";this.collide=false;this.dead=false;this.move=function(e,t){this.x+=e;this.y+=t};this.gravity=function(e){this.GRAVITATIONAL_ACCELERATION=e;this.move(0,this.GRAVITATIONAL_ACCELERATION)};this.oppositeMove=function(e){switch(e){case"left":this.move(15,0);break;case"up":this.move(0,1);break;case"right":this.move(-15,0);break;case"down":this.move(0,-1);break;default:return false}return true};this.enableAI=function(e,t){var n=e%t;if(n==0){this.movementDirection*=-1;console.log("change direction!")}var r=player1.x-this.x;if(r>0){if(r<200){this.move(1.25,0);this.lastMovement="right"}}else if(r<0){if(r>-200){this.move(-1.25,0)}}this.move(this.movementDirection,0)};this.draw=function(){if(this.type=="ghost"){var e=new Image;e.src="img/characters/ghost.png";context.drawImage(e,this.x,this.y+19)}if(this.type=="bat"){var e=new Image;e.src="img/characters/bat.png";context.drawImage(e,this.x,this.y+19)}if(this.type=="eye"){var e=new Image;e.src="img/characters/eye.png";context.drawImage(e,this.x,this.y+19)}if(this.type==undefined){context.beginPath();context.rect(this.x,this.y,this.w,this.h);context.fillStyle="#fff";context.fill()}if(this.dead==true){context.beginPath();context.rect(this.x,this.y,this.w*2,this.h);context.fillStyle="rgba(0,130,205,0.7)";context.fill()}}}function levelEnd(e,t){this.x=e;this.y=t;this.draw=function(){context.fillStyle="#fff843";context.beginPath();context.moveTo(this.x,this.y);context.lineTo(this.x+70,this.y);context.lineTo(this.x+35,this.y+50);context.moveTo(this.x+5,this.y+35);context.lineTo(this.x+35,this.y-15);context.lineTo(this.x+70,this.y+35);context.closePath();context.fill()}}function Animator(e,t,n,r){this.obj=e;this.prop=t;this.startValue=e[t];this.endValue=n;this.valueRange=this.endValue-this.startValue;this.startTime=Date.now();this.animationLength=r;this.finished=false;this.update=function(){if(!this.finished){var n=Date.now()-this.startTime;n=Math.min(n,this.animationLength);var r=n/this.animationLength;e[t]=r*this.valueRange+this.startValue;if(r>=1)this.finished=true}e.draw()}}function checkCollisions(){for(var e=0,t=scene.length;e<t;e++){if(e>0&&scene[e].collision==true){if(collisionTest(scene[e].collision,scene[e])){levelDataText.value+="Collision detected [f: "+frameNumber+"] : player 1 and "+scene[e].constructor.name+" ["+e+"] "+scene[e].type+"\n\n";scene[e].oppositeMove(scene[e].lastMovement);scene[e].collide=true}else{player1.collide=false}}}}function findTileAtCoords(e,t){for(var n=1;n<scene.length;n++){if(e>=scene[n].x&&e<scene[n].x+42&&t>=scene[n].y&&t<scene[n].y+42){return scene[n]}}}function groundCollision(e){for(var t=0,n=scene.length;t<n;t++){if(t>0&&scene[t].collision==true){if(collisionTest(player1,scene[t])){levelDataText.value+="Collision detected [f: "+frameNumber+"] : player 1 and "+scene[t].constructor.name+" ["+t+"] "+scene[t].type+"\n\n";player1.oppositeMove(player1.lastMovement);for(var r=0;r<e.length;r++){e[r].collide=true}}}}}function drawClouds(){for(var e=0;e<cloudAnimations.length;e++){cloudAnimations[e].update();if(cloudAnimations[e].finished==true){cloud[e]=new Cloud;cloudAnimations[e]=new Animator(cloud[e],"x",1280,Math.floor(Math.random()*5e4)+2e4)}}}function drawBullets(){for(var e=0;e<player1.bullets.length;e++){player1.bullets[e].x+=5}}function gameLoop(){var e=+(new Date),t=e-prevLoopTime;if(collisionTest(player1,levEnd)){UI.gameOver(timer.value/1e3,true)}else{timeLeft-=t;timer.value=Math.round(timeLeft/1e3);context.clearRect(0,0,canvas.width,canvas.height);UI.drawHealth(player1.health);for(var n=0,r=scene.length;n<r;n++){scene[n].draw();if(findTileAtCoords(player1.x+player1.w/2,player1.y+player1.h+1)!==undefined){if(findTileAtCoords(player1.x+player1.w/2,player1.y+player1.h+1).collision==false){player1.collide=false}}for(var i=0;i<enemy.length;i++){if(enemy[i]!==null){if(findTileAtCoords(enemy[i].x+enemy[i].w/2,enemy[i].y+enemy[i].h)!==undefined){if(findTileAtCoords(enemy[i].x+enemy[i].w/2,enemy[i].y+enemy[i].h).collision==true){enemy[i].move(0,-42)}}if(player1.health>0){if(collisionTest(enemy[i],player1)&&timer.value>0){player1.health-=.001}else if(player1.health<=100){player1.health+=1e-4}}else{UI.gameOver(0,false);break}for(var s=0;s<player1.bullets.length;s++){if(collisionTest(player1.bullets[s],enemy[i])){player1.bullets.splice(0,1);enemy[i].dead=true;enemy.splice(i,1);score+=100}}}}if(scene[n].collide==false){scene[n].gravity(scene[n].GRAVITATIONAL_ACCELERATION);scene[n].lastMovement="down"}}groundCollision(gravityArray);drawClouds();drawBullets();levelDataText.scrollTop=levelDataText.scrollHeight;for(var i=0;i<enemy.length;i++){enemy[i].enableAI(frameNumber,200)}if(timer.value<0){UI.gameOver(0,false)}prevLoopTime=e;requestAnimFrame(gameLoop);frameNumber++}}var canvas=document.getElementById("gameCanvas"),context=canvas.getContext("2d"),scene=[],prevLoopTime=+(new Date),fpsMeter=document.querySelector("#fpsMeter"),timer=document.querySelector("#timer"),levelDataText=document.querySelector("#levelTxt"),score=0,GRAVITATIONAL_ACCELERATION=100;window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();window.addEventListener("keydown",function(e){switch(e.keyCode){case 37:player1.move(-5,0);player1.lastMovement="left";lev.moveCamera(5,0);break;case 38:player1.jump();player1.lastMovement="up";break;case 39:player1.move(5,0);player1.lastMovement="right";lev.moveCamera(-5,0);break;case 40:player1.move(0,5);player1.lastMovement="down";break;case 88:player1.attack();break;default:return false}e.preventDefault();return true});var player1=new Player;player1.draw();scene.push(player1);var enemy1=new Enemy("eye",1210,364);enemy1.draw();scene.push(enemy1);var enemy2=new Enemy("bat",910,407);enemy2.draw();scene.push(enemy2);var enemy3=new Enemy("ghost",250,450);enemy3.draw();scene.push(enemy3);var enemy4=new Enemy("ghost",2e3,450);enemy4.draw();scene.push(enemy4);var enemy5=new Enemy("eye",2300,450);enemy5.draw();scene.push(enemy5);var levEnd=new levelEnd(3500,400);levEnd.draw();scene.push(levEnd);var gravityArray=[player1,enemy1,enemy2,enemy3,enemy4,enemy5];var gravity=new Gravity(gravityArray);var enemy=[enemy1,enemy2,enemy3,enemy4,enemy5];var cloud=[];var cloudAnimations=[];for(var i=0;i<6;i++){cloud[i]=new Cloud(Math.floor(Math.random()*1200));cloud[i].draw();cloudAnimations[i]=new Animator(cloud[i],"x",1280,Math.floor(Math.random()*5e4)+2e4)}var UI=new UserInterface;var timeLeft=9e4;var lev=new Level;var levelData=lev.load("level1");lev.draw(levelData);var frameNumber=1;gameLoop()